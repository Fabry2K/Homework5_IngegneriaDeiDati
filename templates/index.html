{% extends 'base.html' %}

{% block content %}
  {% if not results and request.method != 'POST' %}
    <div class="d-flex flex-column align-items-center justify-content-center" style="height: 80vh;">
      <h1 class="mb-4">SpeechRec</h1>

      <form method="POST" action="{{ url_for('handle_search') }}" class="search-bar" style="width: 100%; max-width: 600px;">
        <div class="input-group">
          <input type="text" class="form-control form-control-lg" name="query" id="query"
                 placeholder="Enter your search query..." autofocus style="font-size: 1.25rem; padding: 0.75rem;">
          
          {% if index_type == 'figures' or index_type == 'tables' %}
            <input type="text" class="form-control form-control-lg" name="paper_id"
                   placeholder="paper_id (optional)" style="font-size: 1.25rem; padding: 0.75rem;">
          {% endif %}

          <input type="hidden" name="index_type" value="{{ index_type }}">
          <button type="submit" class="btn btn-primary btn-lg px-4">Search</button>
        </div>
      </form>

      <div class="mt-3 d-flex justify-content-between align-items-center" style="width: 100%; max-width: 600px;">
        <div>
          <p class="text-muted mb-0">Searching in: <strong>{{ index_type|capitalize }}</strong></p>
        </div>
        <div class="d-flex gap-2">
          {% if index_type != 'articles' %}
            <a href="{{ url_for('index', index_type='articles') }}" class="btn btn-outline-primary btn-sm">Switch to Articles</a>
          {% endif %}
          {% if index_type != 'figures' %}
            <a href="{{ url_for('index', index_type='figures') }}" class="btn btn-outline-primary btn-sm">Switch to Figures</a>
          {% endif %}
          {% if index_type != 'tables' %}
            <a href="{{ url_for('index', index_type='tables') }}" class="btn btn-outline-primary btn-sm">Switch to Tables</a>
          {% endif %}
        </div>
      </div>
    </div>

  {% elif results is not none %}
    <div class="container mt-4" style="max-width: 900px;">

      <form method="POST" action="{{ url_for('handle_search') }}" id="searchForm" class="mb-2 d-flex" style="width: 100%;">
        <input type="text" class="form-control me-2" name="query" value="{{ query }}" style="font-size: 1.25rem; padding: 0.75rem;">
        
        {% if index_type == 'figures' or index_type == 'tables' %}
          <input type="text" class="form-control me-2" name="paper_id" value="{{ paper_id }}" placeholder="paper_id (optional)" style="font-size: 1.25rem; padding: 0.75rem;">
        {% endif %}

        <input type="hidden" name="index_type" id="index_type_input" value="{{ index_type }}">
        <button type="submit" class="btn btn-primary me-2 px-4">Search</button>

        {% if index_type != 'articles' %}
          <button type="submit" class="btn btn-outline-primary me-1" onclick="document.getElementById('index_type_input').value='articles'">Articles</button>
        {% endif %}
        {% if index_type != 'figures' %}
          <button type="submit" class="btn btn-outline-primary me-1" onclick="document.getElementById('index_type_input').value='figures'">Figures</button>
        {% endif %}
        {% if index_type != 'tables' %}
          <button type="submit" class="btn btn-outline-primary" onclick="document.getElementById('index_type_input').value='tables'">Tables</button>
        {% endif %}
      </form>
      
      <div class="text-center mb-4">
        <p class="text-muted small">Searching in: <strong>{{ index_type|capitalize }}</strong></p>
      </div>

      {% if results|length == 0 %}
        <div class="text-center mt-5">
          <h4>Nessun risultato trovato</h4>
          <p>Prova a cambiare query o filtri.</p>
        </div>
      {% endif %}

      {% if results|length > 0 %}
        <div class="d-flex justify-content-center align-items-center mb-3 gap-3">
          {% if prev_from is not none %}
            <form method="POST">
              <input type="hidden" name="query" value="{{ query }}">
              {% if index_type == 'figures' or index_type == 'tables' %}
                <input type="hidden" name="paper_id" value="{{ paper_id }}">
              {% endif %}
              <input type="hidden" name="from_" value="{{ prev_from }}">
              <input type="hidden" name="index_type" value="{{ index_type }}">
              <button type="submit" class="btn btn-secondary btn-sm">← Previous</button>
            </form>
          {% endif %}
          <span class="text-muted small">Results {{ from_ + 1 }}–{{ from_ + results|length }} of {{ total }}</span>
          {% if next_from is not none %}
            <form method="POST">
              <input type="hidden" name="query" value="{{ query }}">
              {% if index_type == 'figures' or index_type == 'tables' %}
                <input type="hidden" name="paper_id" value="{{ paper_id }}">
              {% endif %}
              <input type="hidden" name="from_" value="{{ next_from }}">
              <input type="hidden" name="index_type" value="{{ index_type }}">
              <button type="submit" class="btn btn-secondary btn-sm">Next →</button>
            </form>
          {% endif %}
        </div>
      {% endif %}

      {% for result in results %}
        <div class="mb-4 p-3 border rounded shadow-sm bg-white">
          {% if index_type == 'articles' %}
            <h5><a href="{{ url_for('get_document', id=result._id) }}">{{ result._source.titolo }}</a></h5>
            <p class="mb-1 small"><strong>Autori:</strong> <span class="text-info">{{ result._source.autori | join(', ') }}</span></p>
            <p class="mb-1 small">
              <strong>Abstract Preview:</strong> 
              {% set abs_str = result._source.abstract %}
              <span class="text-secondary">{{ abs_str[:150] }}{% if abs_str|length > 150 %}...{% endif %}</span>
            </p>

          {% elif index_type == 'figures' %}
            <h5>
              <a href="{{ url_for('get_figure', id=result._id) }}">
                Figure ID: {{ result._id }}
              </a>
            </h5>
            <p class="mb-1 small"><strong>Paper:</strong> {{ result._source.paper_id }}</p>
            <p class="mb-1 small">
              <strong>Caption Preview:</strong>
              {% set cap_str = result._source.caption %}
              <span class="text-info">{{ cap_str[:150] }}{% if cap_str|length > 150 %}...{% endif %}</span>
            </p>
            <p class="mb-1 small">
              <strong>Citing Paragraphs Preview:</strong>
              {% if result._source.citing_paragraphs %}
                {% set cit_str = result._source.citing_paragraphs | join(' | ') %}
                <span class="text-dark">{{ cit_str[:150] }}{% if cit_str|length > 150 %}...{% endif %}</span>
              {% else %}
                <span class="text-muted">None found</span>
              {% endif %}
            </p>

          {% else %}
            <h5><a href="{{ url_for('get_table', id=result._id) }}">Table: {{ result._source.table_id }}</a></h5>
            <p class="mb-1 small"><strong>Paper:</strong> {{ result._source.paper_id }}</p>
            <p class="mb-1 small"><strong>Caption:</strong> {{ result._source.caption }}</p>
            <p class="mb-1 small">
              <strong>Context Paragraphs:</strong> 
              {% if result._source.context_paragraphs %}
                {% set cp_str = result._source.context_paragraphs | join(' | ') %}
                <span class="text-info">{{ cp_str[:150] }}{% if cp_str|length > 150 %}...{% endif %}</span>
              {% else %}
                <span class="text-muted">None found</span>
              {% endif %}
            </p>
            <p class="mb-1 small">
              <strong>Body Preview:</strong> 
              {% set body_str = result._source.body | join(' ') %}
              <span class="text-secondary">{{ body_str[:150] }}{% if body_str|length > 150 %}...{% endif %}</span>
            </p>
          {% endif %}

          <div class="mt-2">
            <span class="badge rounded-pill bg-light text-muted border" style="font-weight: normal; font-size: 0.75rem;">
              Relevance Score: {{ result._score | round(3) }}
            </span>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}
